global
    master-worker
    insecure-fork-wanted
    lua-prepend-path "../target/release/lib?.dylib" cpath
    lua-prepend-path "../target/release/lib?.so" cpath
    tune.lua.bool-sample-conversion normal
    lua-load-per-thread haproxy.lua

defaults
    mode http
    timeout connect 100ms
    timeout client 1s
    timeout server 1s

frontend http-in
    bind *:8080
    http-request lua.start_server_span
    filter lua.opentelemetry-trace
    http-request set-var-fmt(txn.custom_attr_value) "hello"
    http-request lua.set_span_attribute_var test_attribute txn.custom_attr_value
    use_backend status if { path /status }
    default_backend default

backend status
    http-response set-header X-Trace-Id %[var(txn.otel_trace_id)]
    http-response set-header X-Span-Id %[var(txn.otel_span_id)]
    http-request return status 200

backend default
    http-response set-header X-Trace-Id %[var(txn.otel_trace_id)]
    http-response set-header X-Span-Id %[var(txn.otel_span_id)]
    server srv1 127.0.0.1:4317
