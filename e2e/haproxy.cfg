global
    tune.lua.bool-sample-conversion pre-3.1-bug
    master-worker
    insecure-fork-wanted
    lua-load-per-thread /etc/haproxy/lua/otel.lua

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    log stdout format raw local0

frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s

frontend http-in
    bind *:8080
    http-request lua.start_server_span
    filter lua.opentelemetry-trace
    
    # Add custom attributes for testing
    http-request set-var-fmt(txn.path) %[path]
    http-request lua.set_span_attribute_var http.target txn.path
    
    use_backend health if { path /health }
    default_backend app

backend health
    http-request return status 200 content-type text/plain string "OK"

backend app
    server backend backend:5678
