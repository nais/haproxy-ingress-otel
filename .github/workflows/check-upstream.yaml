name: Check Upstream Versions

on:
  schedule:
    # Run every Monday at 08:00 UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-haproxy-ingress:
    name: Check HAProxy Ingress Controller
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          CURRENT=$(grep 'HAPROXY_INGRESS_VERSION=' versions.env | cut -d= -f2)
          if [ -z "$CURRENT" ]; then
            echo "::error::Failed to read HAPROXY_INGRESS_VERSION from versions.env"
            exit 1
          fi
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Get latest upstream version
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Get latest 3.2.x release (we track only latest major branch)
          LATEST=$(gh api repos/haproxytech/kubernetes-ingress/releases --jq \
            '[.[] | select(.tag_name | startswith("v3.2")) | select(.prerelease == false)][0].tag_name' \
            | sed 's/^v//')
          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "::error::Failed to fetch latest upstream version"
            exit 1
          fi
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest upstream version: $LATEST"

      - name: Compare versions
        id: compare
        run: |
          set -euo pipefail
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.upstream.outputs.version }}"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "::notice::New version available: $LATEST (current: $CURRENT)"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "::notice::Already up to date: $CURRENT"
          fi

      - name: Check for existing PR
        id: existing
        if: steps.compare.outputs.update_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          LATEST="${{ steps.upstream.outputs.version }}"
          BRANCH="deps/haproxy-ingress-$LATEST"
          # Check if branch or PR already exists
          if gh pr list --head "$BRANCH" --json number | jq -e '.[0]' > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          elif git ls-remote --heads origin "$BRANCH" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create update PR
        if: steps.compare.outputs.update_available == 'true' && steps.existing.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_VERSION: ${{ steps.current.outputs.version }}
          LATEST_VERSION: ${{ steps.upstream.outputs.version }}
        run: |
          set -euo pipefail
          BRANCH="deps/haproxy-ingress-$LATEST_VERSION"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch and update versions
          git checkout -b "$BRANCH"
          sed -i "s/^HAPROXY_INGRESS_VERSION=.*/HAPROXY_INGRESS_VERSION=$LATEST_VERSION/" versions.env

          # Run sync-versions (cross-platform version)
          source versions.env
          sed -i "s|^ARG RUST_VERSION=.*|ARG RUST_VERSION=$RUST_VERSION|" Dockerfile
          sed -i "s|^ARG HAPROXY_INGRESS_VERSION=.*|ARG HAPROXY_INGRESS_VERSION=$HAPROXY_INGRESS_VERSION|" Dockerfile
          sed -i "s|^ARG HAPROXY_VERSION=.*|ARG HAPROXY_VERSION=$HAPROXY_VERSION|" Dockerfile
          sed -i "s|^ARG S6_OVERLAY_VERSION=.*|ARG S6_OVERLAY_VERSION=$S6_OVERLAY_VERSION|" Dockerfile
          sed -i "s|haproxytech/kubernetes-ingress:[0-9.]*|haproxytech/kubernetes-ingress:$HAPROXY_INGRESS_VERSION|g" e2e/k8s/02-haproxy-ingress.yaml

          # Commit and push
          git add -A
          git commit -m "deps: update HAProxy Ingress to $LATEST_VERSION"
          git push -u origin "$BRANCH"

          # Create PR
          cat > /tmp/pr-body.md << EOF
          ## Automated Update

          Updates HAProxy Kubernetes Ingress Controller from \`$CURRENT_VERSION\` to \`$LATEST_VERSION\`.

          ### Release Notes
          https://github.com/haproxytech/kubernetes-ingress/releases/tag/v$LATEST_VERSION

          ### What's Changed
          - Updated \`versions.env\`
          - Synced Dockerfile ARGs
          - Updated e2e manifest

          ### Testing
          CI will run e2e tests automatically.

          ---
          *This PR was automatically created by the upstream version check workflow.*
          EOF

          gh pr create \
            --title "deps: update HAProxy Ingress to $LATEST_VERSION" \
            --body-file /tmp/pr-body.md

  check-s6-overlay:
    name: Check s6-overlay
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          CURRENT=$(grep 'S6_OVERLAY_VERSION=' versions.env | cut -d= -f2)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT

      - name: Get latest upstream version
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          LATEST=$(gh api repos/just-containers/s6-overlay/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.upstream.outputs.version }}"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "::notice::s6-overlay update available: $LATEST (current: $CURRENT)"
          else
            echo "::notice::s6-overlay up to date: $CURRENT"
          fi

  check-rust:
    name: Check Rust Toolchain
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          CURRENT=$(grep 'RUST_VERSION=' versions.env | cut -d= -f2)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT

      - name: Get latest stable Rust
        id: upstream
        run: |
          set -euo pipefail
          LATEST=$(curl -sfL https://static.rust-lang.org/dist/channel-rust-stable.toml \
            | grep -A1 '\[pkg.rust\]' | grep 'version = ' | cut -d'"' -f2 | cut -d' ' -f1)
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: Compare versions
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.upstream.outputs.version }}"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "::notice::Rust update available: $LATEST (current: $CURRENT)"
          else
            echo "::notice::Rust up to date: $CURRENT"
          fi
